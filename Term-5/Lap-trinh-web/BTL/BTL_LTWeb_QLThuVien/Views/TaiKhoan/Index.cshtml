@using PagedList.Core.Mvc
@model PagedList.Core.IPagedList<Library_Manager.Models.TTaiKhoan>

@{
    ViewData["Title"] = "Quản lý Tài khoản";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var userRole = Context.Session.GetString("UserRole");
    // Chỉ QTV mới có quyền chỉnh sửa/thêm/xóa
    bool canEdit = (userRole == "QTV");
}

@* ========================================================================
    KHỐI 2: CẤU TRÚC BỐ CỤC CHÍNH (CONTAINER)
    ======================================================================== *@
<div class="container-xxl flex-grow-1 container-p-y">

    @* --- KHỐI HIỂN THỊ THÔNG BÁO TỪ TEMP DATA (CHO THÀNH CÔNG/THẤT BẠI) --- *@
    @if (TempData["Message"] != null)
    {
        <div id="indexAlertMessage" class="alert alert-@(TempData["StatusMessage"]) alert-dismissible" role="alert">
            @Html.Raw(TempData["Message"])
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- PHẦN 2.1: TIÊU ĐỀ TRANG --- *@
    <h1 class="fw-bold text-primary mb-4">
        <i class='bx bxs-user-account fa-border fs-1 me-2'></i> @ViewData["Title"]
    </h1>

    <div class="card">
        @* --- PHẦN 2.2: THANH TÁC VỤ (SEARCH & CREATE) --- *@
        <div class="card-header border-bottom">

            <div class="d-flex justify-content-between align-items-center">

                @* 1. Thanh Tìm kiếm (Bọc trong Form và chiếm hết không gian còn lại) *@
                <div class="flex-grow-1 me-3">
                    <form asp-action="Index" method="get">
                        <partial name="SearchBar" />
                    </form>
                </div>

                @* 2. Nút Thêm mới (Cố định, căn phải) *@
                <div class="flex-shrink-0">
                    <p class="m-0">
                        <a asp-action="Create" class="btn btn-primary text-nowrap @(canEdit ? "" : "disabled")">
                            <i class="bx bx-plus me-1"></i> Thêm Tài khoản
                        </a>
                    </p>
                </div>
            </div>
        </div>


        @* ========================================================================
            KHỐI 3: BẢNG DỮ LIỆU VÀ PHÂN TRANG
            ======================================================================== *@
        <div class="table-responsive">
            <table class="table table-bordered text-nowrap table-hover" id="myTable">

                @* --- PHẦN 3.1: TIÊU ĐỀ BẢNG (THEAD) --- *@
                <thead id="myTableHead">
                    <tr>
                        <th style="white-space: nowrap;">Mã TK</th>
                        <th style="white-space: nowrap;">Tên đăng nhập</th>
                        <th>Trạng thái</th>
                        <th>Vai trò</th>
                        <th>Tên Nhân viên</th>
                        <th>Ngày tạo</th>
                        <th style="min-width: 120px;">Hành động</th>
                    </tr>
                </thead>

                @* --- PHẦN 3.2: NỘI DUNG BẢNG (TBODY) --- *@
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            @* Logic cho Badge Trạng Thái *@
                            var trangThai = item.TrangThai;
                            var badgeTrangThaiClass = trangThai == "Hoạt động" ? "bg-label-success" : "bg-label-danger";
                            @* Logic cho Badge Vai Trò *@
                            var vaiTro = item.MaVtNavigation?.MaVt;
                            var badgeVaiTroClass = "bg-label-secondary";
                            if (vaiTro == "QTV") { badgeVaiTroClass = "bg-label-primary"; }
                            else if (vaiTro == "QLB") { badgeVaiTroClass = "bg-label-info"; }
                            else if (vaiTro == "QLT") { badgeVaiTroClass = "bg-label-warning"; }
                            else if (vaiTro == "QLM") { badgeVaiTroClass = "bg-label-primary"; }


                            <tr>
                                <td style="white-space: nowrap;">
                                    <span class="fw-bold">@item.MaTk</span>
                                </td>
                                <td>
                                    <span class="fw-bold">@item.TenDangNhap</span>
                                </td>
                                <td>
                                    <span class="badge @badgeTrangThaiClass">@trangThai</span>
                                </td>
                                <td>
                                    <span class="badge @badgeVaiTroClass">@item.MaVtNavigation?.TenVt</span>
                                </td>
                                <td style="white-space: nowrap;">
                                    @(item.MaNvNavigation != null ? (item.MaNvNavigation.HoDem + " " + item.MaNvNavigation.Ten) : "(Chưa liên kết)")
                                </td>
                                <td>@item.NgayTao.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <div class="d-flex w-100 justify-content-around">

                                        @* 1. Chi tiết (Details) *@
                                        <a asp-action="Details" asp-route-id="@item.MaTk"
                                           class="btn btn-icon btn-label-info waves-effect"
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="Chi tiết">
                                            <i class='bx bx-detail'></i>
                                        </a>

                                        @* 2. Sửa (Edit) - Chỉ QTV *@
                                        <a asp-action="Edit" asp-route-id="@item.MaTk"
                                           class="btn btn-icon btn-label-primary waves-effect @(canEdit ? "" : "disabled")"
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="Sửa">
                                            <i class='bx bx-pencil'></i>
                                        </a>

                                        @* 3. Xóa (Delete) - Chỉ QTV *@
                                        <a asp-action="Delete" asp-route-id="@item.MaTk"
                                           class="btn btn-icon btn-label-danger waves-effect @(canEdit ? "" : "disabled")"
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="Xóa">
                                            <i class='bx bx-trash'></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center p-4">
                                <h5 class="mb-0 text-muted">Không có dữ liệu</h5>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* --- PHẦN 3.3: PHÂN TRANG (PAGINATION) --- *@
        <div class="card-footer pt-0">
            <partial name="_Pagination" />
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const alertElement = document.getElementById('indexAlertMessage');

            // Chỉ chạy nếu có thông báo và là thông báo thành công
            @if (TempData["StatusMessage"] != null && TempData["StatusMessage"].ToString() == "success")
            {
                        <text>
                            if (alertElement) {
                                // Tự động ẩn sau 5 giây (5000ms)
                                setTimeout(() => {
                                    $(alertElement).alert('close');
                                }, 5000);
                            }
                        </text>
            }
        });
    </script>
}