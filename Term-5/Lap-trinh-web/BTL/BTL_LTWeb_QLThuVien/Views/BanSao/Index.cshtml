@using PagedList.Core.Mvc
@model PagedList.Core.IPagedList<Library_Manager.Models.TBanSao>

@{
    var maTlContext = ViewBag.MaTl;
    var tenTaiLieu = ViewBag.TenTaiLieu;
    var userRole = Context.Session.GetString("UserRole");
    bool canEdit = (userRole == "QTV" || userRole == "QLT");

    ViewData["Title"] = "Bản sao: " + tenTaiLieu;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-xxl flex-grow-1 container-p-y">

    <h1 class="fw-bold text-primary mb-2">
        <i class='bx bx-copy-alt fa-border fs-1 me-2'></i>
        Danh sách Bản sao
    </h1>
    <h3 class="mb-4 text-secondary">của Tài liệu: <span class="text-primary">@tenTaiLieu (@maTlContext)</span></h3>

    @* ✅ HIỂN THỊ THÔNG BÁO (HỖ TRỢ CẢ 2 LOẠI TEMPDATA) *@
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-@(TempData["StatusMessage"]) alert-dismissible fade show" role="alert">
            @Html.Raw(TempData["Message"])
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    else if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Html.Raw(TempData["SuccessMessage"])
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card">
        <div class="card-header border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1 me-3">
                    <partial name="SearchBar" />
                </div>

                <div class="flex-shrink-0">
                    <p class="m-0">
                        <a asp-action="Create" asp-route-MaTl="@maTlContext" class="btn btn-primary text-nowrap @(canEdit ? "" : "disabled")">
                            <i class="bx bx-plus me-1"></i> Thêm Bản sao mới
                        </a>
                    </p>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="myTable">
                <thead id="myTableHead">
                    <tr>
                        <th>Mã Bản sao</th>
                        <th>Tình trạng</th>
                        <th style="min-width: 120px;">Hành động</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td style="white-space: nowrap;"><strong>@item.MaBs</strong></td>

                                <td style="white-space: nowrap;">
                                    @{
                                        var tinhTrang = item.TrangThai;
                                        var badgeClass = tinhTrang switch
                                        {
                                            "Có sẵn" => "bg-label-success",
                                            "Đang mượn" => "bg-label-warning",
                                            "Hỏng" => "bg-label-danger",
                                            _ => "bg-label-secondary",
                                        };
                                    }
                                    <span class="badge @badgeClass">@tinhTrang</span>
                                </td>

                                <td>
                                    <div class="d-flex w-100 justify-content-around">
                                        <a asp-action="Delete" asp-route-id="@item.MaBs"
                                           class="btn btn-icon btn-label-danger waves-effect @(canEdit ? "" : "disabled")"
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="Xóa">
                                            <i class='bx bx-trash'></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" class="text-center text-muted py-5">
                                <i class='bx bx-info-circle me-1'></i> Không có bản sao nào được tìm thấy cho tài liệu này.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="card-footer pt-0">
            <partial name="_Pagination" />
        </div>

        <div class="card-footer border-top pt-3">
            <a asp-controller="TaiLieu" asp-action="Details" asp-route-id="@maTlContext" class="btn btn-secondary">
                <i class="bx bx-arrow-back me-1"></i> Quay lại chi tiết Tài liệu
            </a>
        </div>
    </div>
</div>