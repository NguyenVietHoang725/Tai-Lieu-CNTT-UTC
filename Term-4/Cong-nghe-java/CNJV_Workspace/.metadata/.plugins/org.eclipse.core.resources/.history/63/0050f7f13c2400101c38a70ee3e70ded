package com.battleship.model.attack;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.battleship.enums.AttackType;
import com.battleship.interfaces.IAttackStrategy;
import com.battleship.model.board.Board;
import com.battleship.model.board.Node;

/**
 * Lớp "AttackLogic" biểu diễn logic tấn công trong trò chơi, sử dụng các chiến lược tấn công khác nhau
 * 
 * @author Nguyen Viet Hoang
 * @version 1.0
 * @since 2025-04-27
 */

public class AttackLogic {
    // --- THUỘC TÍNH ---
	private final Board board; // Bảng trò chơi
	private final AttackInventory atkInv; // Kho tấn công
	private final Map<AttackType, IAttackStrategy> strategies; // Các chiến lược tấn công
	
	// --- HÀM KHỞI TẠO ---
	/**
	 * Hàm khởi tạo với 2 tham số:
	 * 
	 * @param board Bảng trò chơi
	 * @param atkInv Kho tấn công
	 */
	public AttackLogic(Board board, AttackInventory atkInv) {
		this.board = board;
		this.atkInv = atkInv;
		this.strategies = new HashMap<>();
		// Khởi tạo các chiến lược
        strategies.put(AttackType.SINGLE, new SingleAttackStrategy());
        strategies.put(AttackType.CROSS, new CrossAttackStrategy());
        strategies.put(AttackType.RANDOM, new RandomAttackStrategy());
        strategies.put(AttackType.DIAMOND, new DiamondAttackStrategy());
	}
	
	/**
     * Hàm thực hiện tấn công với loại đạn và vị trí chỉ định
     * 
     * @param type Loại đạn
     * @param x Tọa độ x
     * @param y Tọa độ y
     * @return Danh sách các điểm đã bắn trúng tàu
     */
	public List<Node> attack(AttackType type, int x, int y) {
        Node center = board.getNode(x, y); // Ô trung tâm

        if (center.isHit()) return new ArrayList<>(); // Nếu ô trung tâm đã bắn trúng tàu, trả về danh sách rỗng

        if (!atkInv.hasAttack(type)) return new ArrayList<>(); // Nếu không còn tấn công loại này, trả về danh sách rỗng

        IAttackStrategy strategy = strategies.get(type);
        if (strategy == null) return new ArrayList<>(); // Nếu không có chiến lược tấn công, trả về danh sách rỗng

        List<Node> targets = strategy.getAttackPoints(x, y, board); // Lấy danh sách các ô cần tấn công
        List<Node> attacked = new ArrayList<>(); // Danh sách các ô đã bắn trúng tàu

        for (Node node : targets) {
            node.setHit(true); // Đánh dấu ô đã bắn trúng tàu
            attacked.add(node); // Thêm ô đã bắn trúng tàu vào danh sách
        }

        atkInv.useAttack(type); // Sử dụng tấn công loại này
        return attacked; // Trả về danh sách các ô đã bắn trúng tàu
    }
}
