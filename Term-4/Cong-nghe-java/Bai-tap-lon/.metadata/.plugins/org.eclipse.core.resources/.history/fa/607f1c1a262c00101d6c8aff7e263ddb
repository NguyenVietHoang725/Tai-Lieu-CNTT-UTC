package com.battleship.core.service.impl;

import com.battleship.core.model.Position;
import com.battleship.core.model.attack.Attack;
import com.battleship.core.model.attack.AttackResult;
import com.battleship.core.model.game.GameMode;
import com.battleship.core.model.game.GameState;
import com.battleship.core.model.game.GameStatus;
import com.battleship.core.model.player.IPlayer;
import com.battleship.core.model.ship.Ship;
import com.battleship.core.service.interfaces.IAttackService;
import com.battleship.core.service.interfaces.IBoardService;
import com.battleship.core.service.interfaces.IGameService;
import com.battleship.core.service.interfaces.IPlayerService;

public class GameServiceImpl implements IGameService {
    private final IPlayerService playerService;
    private final IAttackService attackService;
    private final IBoardService boardService;
    
    private GameState gameState;
    private GameMode gameMode;
    
    public GameServiceImpl(IPlayerService playerService, 
                          IAttackService attackService,
                          IBoardService boardService) {
        this.playerService = playerService;
        this.attackService = attackService;
        this.boardService = boardService;
    }
    
    @Override
    public void startGame(GameMode mode) {
        this.gameMode = mode;
        
        IPlayer player1, player2;
        if (mode == GameMode.CHALLENGE) {
            player1 = playerService.createPlayer("Player 1");
            player2 = playerService.createPlayer("Player 2");
        } else {
            player1 = playerService.createPlayer("Player");
            player2 = playerService.createBot("Bot", "MEDIUM");
        }
        
        this.gameState = new GameState(player1, player2, mode);
    }
    
    @Override
    public void handleAttack(Attack attack) {
        if (gameState.getStatus() != GameStatus.IN_PROGRESS) {
            throw new IllegalStateException("Game is not in progress");
        }
        
        AttackResult result = attackService.executeAttack(
            gameState.getCurrentPlayer(), 
            gameState.getOpponent(), 
            attack.getPosition()
        );
        
        if (result.getHitShip() != null || !result.isHit()) {
            switchTurn();
        }
        
        checkGameOver();
    }
    
    @Override
    public void endGame() {
        if (playerService.isDefeated(gameState.getCurrentPlayer())) {
            gameState.setStatus(GameStatus.BOT_WON);
        } else if (playerService.isDefeated(gameState.getOpponent())) {
            gameState.setStatus(GameStatus.PLAYER_WON);
        } else {
            gameState.setStatus(GameStatus.DRAW);
        }
    }
    
    @Override
    public GameState getCurrentState() {
        return gameState;
    }
    
    @Override
    public boolean isGameOver() {
        return gameState.getStatus() != GameStatus.IN_PROGRESS;
    }
    
    @Override
    public IPlayer getCurrentPlayer() {
        return gameState.getCurrentPlayer();
    }
    
    @Override
    public IPlayer getOpponent() {
        return gameState.getOpponent();
    }
    
    @Override
    public void switchTurn() {
        IPlayer temp = gameState.getCurrentPlayer();
        gameState.setCurrentPlayer(gameState.getOpponent());
        gameState.setOpponent(temp);
    }
    
    @Override
    public void placeShip(IPlayer player, Ship ship, Position position) {
        if (gameState.getStatus() != GameStatus.IN_PROGRESS) {
            throw new IllegalStateException("Cannot place ships in current state");
        }
        
        playerService.placeShip(player, ship, position);
        
        // Check if all ships are placed
        if (areAllShipsPlaced(gameState.getCurrentPlayer()) && 
            areAllShipsPlaced(gameState.getOpponent())) {
            gameState.setStatus(GameStatus.IN_PROGRESS);
        }
    }
    
    private boolean areAllShipsPlaced(IPlayer player) {
        return player.getBoard().getShips().size() == 5; // Assuming 5 ships per player
    }
    
    private void checkGameOver() {
        if (playerService.isDefeated(gameState.getCurrentPlayer()) || 
            playerService.isDefeated(gameState.getOpponent())) {
            endGame();
        }
    }
}
