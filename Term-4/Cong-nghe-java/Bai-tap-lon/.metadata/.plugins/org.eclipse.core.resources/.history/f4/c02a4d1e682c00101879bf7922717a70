package com.battleship.core.service.board;

import java.util.ArrayList;
import java.util.List;

import com.battleship.core.model.board.Board;
import com.battleship.core.model.board.Node;
import com.battleship.core.model.board.Position;
import com.battleship.core.model.ship.Ship;

public class ShipPlacementServiceImpl implements IShipPlacementService {
	private final Board board;
    private final List<Position> placedShipPositions;
    
    public ShipPlacementServiceImpl(Board board) {
        this.board = board;
        this.placedShipPositions = new ArrayList<>();
    }
	
	@Override
	public boolean placeShip(Ship ship, Position position) {
        if (!canPlaceShip(ship, position)) {
            return false;
        }
        
        // Đặt tàu vào các vị trí
        for (int i = 0; i < ship.getLength(); i++) {  // Thay getSize() bằng getLength()
            Position shipPosition = new Position(
                position.getX() + (ship.isHorizontal() ? i : 0),
                position.getY() + (ship.isHorizontal() ? 0 : i)
            );
            
            Node node = board.getNode(shipPosition);
            node.setShip(ship);
            placedShipPositions.add(shipPosition);
        }
        
        return true;
    }

	@Override
	public boolean isValidPlacement(Ship ship, Position position) {
		// Kiểm tra xem tàu có nằm trong bàn cờ không
        if (!isWithinBoard(ship, position)) {
            return false;
        }
        
        // Kiểm tra xem có tàu nào khác ở vị trí này không
        if (hasOverlap(ship, position)) {
            return false;
        }
        
        // Kiểm tra khoảng cách với tàu khác
        if (hasAdjacentShip(ship, position)) {
            return false;
        }
        
        return true;
	}

	@Override
	public List<Position> getPlacedShipPositions() {
		return new ArrayList<>(placedShipPositions);
	}

	@Override
	public void removeShip(Position position) {
		Node node = board.getNode(position);
        if (node.hasShip()) {
            Ship ship = node.getShip();
            // Xóa tàu khỏi tất cả các vị trí
            for (Position pos : placedShipPositions) {
                if (board.getNode(pos).getShip() == ship) {
                    board.getNode(pos).clear();
                }
            }
            placedShipPositions.removeIf(pos -> 
                board.getNode(pos).getShip() == ship);
        }
	}

	@Override
	public boolean canPlaceShip(Ship ship, Position position) {
		return isValidPlacement(ship, position);
	}
	
	private boolean hasOverlap(Ship ship, Position position) {
        for (int i = 0; i < ship.getSize(); i++) {
            Position checkPos = new Position(
                position.getX() + (ship.isHorizontal() ? i : 0),
                position.getY() + (ship.isHorizontal() ? 0 : i)
            );
            
            if (board.getNode(checkPos).hasShip()) {
                return true;
            }
        }
        return false;
    }
    
    private boolean hasAdjacentShip(Ship ship, Position position) {
        for (int i = -1; i <= ship.getSize(); i++) {
            for (int j = -1; j <= 1; j++) {
                Position checkPos = new Position(
                    position.getX() + (ship.isHorizontal() ? i : j),
                    position.getY() + (ship.isHorizontal() ? j : i)
                );
                
                if (isValidPosition(checkPos) && board.getNode(checkPos).hasShip()) {
                    return true;
                }
            }
        }
        return false;
    }
    
    private boolean isValidPosition(Position position) {
        return position.getX() >= 0 && position.getX() < board.getWidth() &&
               position.getY() >= 0 && position.getY() < board.getHeight();
    }
}
