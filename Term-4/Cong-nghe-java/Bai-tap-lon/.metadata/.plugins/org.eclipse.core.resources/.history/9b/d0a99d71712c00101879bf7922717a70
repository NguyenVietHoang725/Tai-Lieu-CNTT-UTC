package com.battleship.core.service.board;

import com.battleship.core.model.attack.AttackResult;
import com.battleship.core.model.board.Board;
import com.battleship.core.model.board.Node;
import com.battleship.core.model.board.Position;
import com.battleship.core.model.player.Player;
import com.battleship.core.model.ship.Ship;
import com.battleship.data.DataConstants;
import com.battleship.data.loader.BotBoardLoader;
import com.battleship.data.loader.ChallengeBoardLoader;

public class BoardServiceImpl implements IBoardService {
	private Board board;
    private final IShipPlacementService shipPlacementService;
    
    public BoardServiceImpl(Board board, IShipPlacementService shipPlacementService) {
        this.board = board;
        this.shipPlacementService = shipPlacementService;
    }
    
	@Override
	public boolean placeShip(Ship ship, Position position) {
		if (!isValidPlacement(ship, position)) {
            return false;
        }
        return shipPlacementService.placeShip(ship, position);
	}

	@Override
	public boolean isValidPlacement(Ship ship, Position position) {
		return shipPlacementService.isValidPlacement(ship, position);
	}

	@Override
	public void updateBoard(AttackResult result) {
		Position position = result.getPosition();
        Node node = board.getNode(position);
        
        if (result.isHit()) {
            node.hit();
        } else {
            node.miss();
        }
	}

	@Override
	public Board getBoard(Player player) {
		return board;
	}

	@Override
	public boolean areAllShipsPlaced() {
		return shipPlacementService.getPlacedShipPositions().size() == 
	               board.getRequiredShipCount();
	}

	@Override
	public void resetBoard() {
		board.clear();
        shipPlacementService.getPlacedShipPositions().clear();
	}

	@Override
    public boolean loadBoard(String filePath) {
        try {
            // Sử dụng BotBoardLoader cho chế độ VS Bot
            if (filePath.contains(DataConstants.VSBOT_DIR)) {
                BotBoardLoader loader = new BotBoardLoader();
                this.board = loader.loadBoard(filePath);
                return true;
            }
            // Sử dụng ChallengeBoardLoader cho chế độ Challenge
            else if (filePath.contains(DataConstants.CHALLENGE_DIR)) {
                ChallengeBoardLoader loader = new ChallengeBoardLoader();
                this.board = loader.loadBoard(filePath);
                return true;
            }
            return false;
        } catch (Exception e) {
            return false;
        }
    }

    @Override
    public void setBoard(Board board) {
        if (board == null) {
            throw new IllegalArgumentException("Board cannot be null");
        }
        this.board = board;
    }

    // Thêm getter cho board
    public Board getBoard() {
        return this.board;
    }

}
