package com.battleship.core.service.impl;

import com.battleship.core.model.Position;
import com.battleship.core.model.attack.AttackResult;
import com.battleship.core.model.attack.AttackType;
import com.battleship.core.model.player.IPlayer;
import com.battleship.core.service.interfaces.IAttackService;
import com.battleship.core.service.interfaces.IBoardService;
import com.battleship.core.service.interfaces.IPlayerService;

public class AttackServiceImpl implements IAttackService {
	private final IBoardService boardService;
    private final IPlayerService playerService;
    
    public AttackServiceImpl(IBoardService boardService, IPlayerService playerService) {
        this.boardService = boardService;
        this.playerService = playerService;
    }
    
    @Override
    public AttackResult executeAttack(IPlayer attacker, IPlayer defender, Position position) {
        if (!isValidAttack(attacker, position)) {
            return new AttackResult(false, false, null);
        }
        
        // Check if player has enough shots
        if (playerService.getShotsRemaining(attacker) <= 0) {
            throw new IllegalStateException("No shots remaining");
        }
        
        AttackResult result = boardService.handleAttack(defender.getBoard(), position);
        playerService.updatePlayerState(defender, result);
        
        if (result.isHit()) {
            playerService.updatePlayerState(attacker, result);
        }
        
        return result;
    }
    
    @Override
    public boolean isValidAttack(IPlayer attacker, Position position) {
        return playerService.canAttack(attacker, position);
    }
    
    @Override
    public void updateAttackInventory(IPlayer player, AttackType type) {
        // Không cần thực hiện gì vì inventory được khởi tạo với số lượng cố định
        // và không có phương thức để thêm vũ khí mới
    }
    
    @Override
    public boolean hasWeapon(IPlayer player, AttackType type) {
        return player.getInventory().hasWeapon(type);
    }
    
    @Override
    public void useWeapon(IPlayer player, AttackType type) {
        player.getInventory().useWeapon(type);
    }

}
